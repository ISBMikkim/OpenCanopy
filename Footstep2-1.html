<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Footstep 2: Upload your MAP</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK Ïä§ÌÅ¨Î¶ΩÌä∏ ÏûÑÌè¨Ìä∏
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            getDoc,
            updateDoc,
            onSnapshot,
            Timestamp,
            increment,
            serverTimestamp,
            query,
            orderBy,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase ÏÑ§Ï†ï ---
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
              apiKey: "AIzaSyDRPKmza6cNgnxiT6qo4YHk4uiHue2j8ug",
              authDomain: "isbopencanopy-f92d3.firebaseapp.com",
              projectId: "isbopencanopy-f92d3",
              storageBucket: "isbopencanopy-f92d3.firebasestorage.app",
              messagingSenderId: "253275410619",
              appId: "1:253275410619:web:e20db952dc1f12f54f199e"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-map-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let userId = null;

        // --- Speech Recognition (STT) ÏÑ§Ï†ï ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let currentRecordingTextarea = null;
        let isRecording = false;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onstart = () => {
                isRecording = true;
                const recordBtn = currentRecordingTextarea.closest('form, .new-comment-form, .reply-form').querySelector('.record-btn');
                if (recordBtn) {
                    recordBtn.textContent = 'üõë';
                    recordBtn.classList.add('is-recording');
                }
            };
            recognition.onend = () => {
                isRecording = false;
                if (currentRecordingTextarea) {
                    const recordBtn = currentRecordingTextarea.closest('form, .new-comment-form, .reply-form').querySelector('.record-btn');
                    if (recordBtn) {
                        recordBtn.textContent = 'üé§';
                        recordBtn.classList.remove('is-recording');
                    }
                }
                currentRecordingTextarea = null;
            };
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                if (currentRecordingTextarea) {
                    currentRecordingTextarea.value += transcript + ' ';
                }
            };
            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                if (isRecording) recognition.stop();
            };
        }

        // --- Í≥µÏö© Îç∞Ïù¥ÌÑ∞ Í≤ΩÎ°ú ---
        const postsCollectionPath = `artifacts/${appId}/public/data/student-maps`;

        // --- UI ÏöîÏÜå ---
        const postsGrid = document.getElementById('posts-grid');
        const addPostCard = document.getElementById('add-post-card');
        const loadingOverlay = document.getElementById('loading-overlay');
        const newPostForm = document.getElementById('new-post-form');
        const newFileInput = document.getElementById('new-file-input');
        const newImagePreview = document.getElementById('new-image-preview');
        const newImagePreviewContainer = document.getElementById('new-image-preview-container');
        const newFileLabel = document.getElementById('new-file-label');
        const newDescriptionInput = document.getElementById('new-description-input');
        const newRecordBtn = document.getElementById('new-record-btn');
        const postTemplate = document.getElementById('post-template');
        const commentTemplate = document.getElementById('comment-template');

        // --- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ ---
        function showLoading(message = "Uploading...") {
            loadingOverlay.querySelector('p').textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // --- 1. Ïù∏Ï¶ù Î∞è Ïï± Ï¥àÍ∏∞Ìôî ---
        async function initializeAppAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    loadPosts();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Sign-in failed:", error);
                    }
                }
            });
        }

        // --- 2. Í≤åÏãúÎ¨º Î°úÎìú (Ïã§ÏãúÍ∞Ñ) ---
        function loadPosts() {
            const postsRef = query(collection(db, postsCollectionPath));
            onSnapshot(postsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const postData = { id: change.doc.id, ...change.doc.data() };
                    const existingCard = document.querySelector(`.post-card[data-post-id="${postData.id}"]`);
                    if (change.type === "added") {
                        renderPost(postData);
                    }
                    if (change.type === "modified" && existingCard) {
                        const reactionsContainer = existingCard.querySelector('.reactions-container');
                        ['heart', 'smile'].forEach(emojiName => {
                            const countSpan = reactionsContainer.querySelector(`[data-emoji="${emojiName}"] .count`);
                            if(countSpan) countSpan.textContent = postData.reactions[emojiName] || 0;
                        });
                    }
                    if (change.type === "removed" && existingCard) {
                        existingCard.remove();
                    }
                });
            }, (error) => {
                console.error("Failed to load posts:", error);
            });
        }

        // --- 3. Í≤åÏãúÎ¨º Ïπ¥Îìú Î†åÎçîÎßÅ ---
        function renderPost(postData) {
            const postCard = postTemplate.content.cloneNode(true).firstElementChild;
            postCard.dataset.postId = postData.id;
            const img = postCard.querySelector('.post-image');
            img.src = postData.imageUrl;
            const descriptionContainer = postCard.querySelector('.post-description-container');
            const descriptionText = descriptionContainer.querySelector('.post-description-text');
            if (postData.description) {
                descriptionText.textContent = postData.description;
                descriptionContainer.classList.remove('hidden');
            } else {
                descriptionContainer.classList.add('hidden');
            }
            const reactionsContainer = postCard.querySelector('.reactions-container');
            ['heart', 'smile'].forEach(emojiName => {
                const btn = reactionsContainer.querySelector(`[data-emoji="${emojiName}"]`);
                btn.querySelector('.count').textContent = postData.reactions[emojiName] || 0;
                btn.onclick = () => handleReactionClick(postData.id, emojiName);
            });
            postCard.querySelector('.post-comment-btn').onclick = (e) => handlePostComment(e, postData.id);
            postCard.querySelector('.record-btn').onclick = (e) => handleSpeechRecognition(e, e.target.closest('.new-comment-form'));
            loadComments(postData.id, postCard.querySelector('.comments-list'));
            postsGrid.insertBefore(postCard, addPostCard);
        }

        // --- 4. ÎåìÍ∏Ä Î°úÎìú (Ïã§ÏãúÍ∞Ñ) ---
        function loadComments(postId, commentsListContainer) {
            const commentsRef = collection(db, postsCollectionPath, postId, 'comments');
            onSnapshot(query(commentsRef, orderBy("createdAt", "asc")), (snapshot) => {
                commentsListContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    renderComment({ id: doc.id, ...doc.data() }, commentsListContainer, postId);
                });
            });
        }

        // --- 5. ÎåìÍ∏Ä Ïπ¥Îìú Î†åÎçîÎßÅ ---
        function renderComment(commentData, commentsListContainer, postId) {
            const commentCard = commentTemplate.content.cloneNode(true).firstElementChild;
            const commentTextEl = commentCard.querySelector('.comment-text');
            
            // ÌÖçÏä§Ìä∏ÏôÄ ÏûëÏÑ±Ïûê Ï†ïÎ≥¥Î•º Ìï®Íªò ÌëúÏãú
            const textNode = document.createTextNode(commentData.text || "Comment");
            const authorSpan = document.createElement('span');
            authorSpan.className = 'text-xs text-gray-500 ml-2';
            authorSpan.textContent = `(by anonymous)`;
            commentTextEl.appendChild(textNode);
            commentTextEl.appendChild(authorSpan);
            
            const replyBtn = commentCard.querySelector('.reply-btn');
            const replyForm = commentCard.querySelector('.reply-form');
            const replyInput = replyForm.querySelector('.reply-input');

            // --- BUG FIX: Reply Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏûÖÎ†•Ï∞Ω ÌôúÏÑ±Ìôî ---
            replyBtn.onclick = () => {
                const isHidden = replyForm.style.display === 'none' || replyForm.style.display === '';
                replyForm.style.display = isHidden ? 'block' : 'none';
                if (isHidden) {
                    replyInput.focus(); // ÌèºÏùÑ Î≥¥Ïó¨Ï§Ñ Îïå ÏûÖÎ†•Ï∞ΩÏóê Ìè¨Ïª§Ïä§
                }
            };
            
            replyForm.querySelector('.post-reply-btn').onclick = (e) => handlePostReply(e, postId, commentData.id);
            replyForm.querySelector('.record-btn').onclick = (e) => handleSpeechRecognition(e, replyForm);
            
            loadReplies(postId, commentData.id, commentCard.querySelector('.replies-list'));
            commentsListContainer.appendChild(commentCard);
            addSwipeToDelete(commentCard, () => deleteComment(postId, commentData.id));
        }

        // --- 6. ÎãµÍ∏Ä Î°úÎìú (Ïã§ÏãúÍ∞Ñ) ---
        function loadReplies(postId, commentId, repliesListContainer) {
            const repliesRef = collection(db, postsCollectionPath, postId, 'comments', commentId, 'replies');
            onSnapshot(query(repliesRef, orderBy("createdAt", "asc")), (snapshot) => {
                repliesListContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    renderReply({ id: doc.id, ...doc.data() }, repliesListContainer, postId, commentId);
                });
            });
        }

        // --- 7. ÎãµÍ∏Ä Ïπ¥Îìú Î†åÎçîÎßÅ ---
        function renderReply(replyData, repliesListContainer, postId, commentId) {
            const replyCard = commentTemplate.content.cloneNode(true).firstElementChild;
            const replyTextEl = replyCard.querySelector('.comment-text');

            // ÌÖçÏä§Ìä∏ÏôÄ ÏûëÏÑ±Ïûê Ï†ïÎ≥¥Î•º Ìï®Íªò ÌëúÏãú
            const textNode = document.createTextNode(replyData.text || "Reply");
            const authorSpan = document.createElement('span');
            authorSpan.className = 'text-xs text-gray-500 ml-2';
            authorSpan.textContent = `(by anonymous)`;
            replyTextEl.appendChild(textNode);
            replyTextEl.appendChild(authorSpan);
            
            replyCard.querySelector('.reply-btn').remove();
            replyCard.querySelector('.reply-form').remove();
            replyCard.querySelector('.replies-list').remove();
            repliesListContainer.appendChild(replyCard);
            addSwipeToDelete(replyCard, () => deleteReply(postId, commentId, replyData.id));
        }
        
        // --- 7.5. ÌååÏùº ÏóÖÎ°úÎìú ---
        function uploadFile(file, storagePath) {
            return new Promise((resolve, reject) => {
                const uploadTask = uploadBytesResumable(ref(storage, storagePath), file);
                uploadTask.on('state_changed', null, reject, () => getDownloadURL(uploadTask.snapshot.ref).then(resolve).catch(reject));
            });
        }

        // --- 8. ÏÉà Í≤åÏãúÎ¨º Ï∂îÍ∞Ä ---
        async function submitNewPost(e) {
            e.preventDefault();
            const file = newFileInput.files[0];
            const description = newDescriptionInput.value.trim();
            if (!file || !description) return alert("Please select an image and enter a description.");
            showLoading("Uploading map...");
            try {
                const fileId = `${Date.now()}-${file.name}`;
                const imagePath = `artifacts/${appId}/public/data/images/${fileId}`;
                const imageUrl = await uploadFile(file, imagePath);
                await addDoc(collection(db, postsCollectionPath), {
                    imageUrl, description, userId, createdAt: serverTimestamp(), reactions: { heart: 0, smile: 0 }
                });
                newPostForm.reset();
                newImagePreview.src = '';
                newImagePreviewContainer.classList.add('hidden');
                newFileLabel.classList.remove('hidden');
            } catch (error) {
                alert("Failed to upload post. Error: " + error.message);
            } finally {
                hideLoading();
            }
        }

        // --- 9. Ïù¥Î™®ÏßÄ Î∞òÏùë ÌÅ¥Î¶≠ ---
        async function handleReactionClick(postId, emojiName) {
            await updateDoc(doc(db, postsCollectionPath, postId), { [`reactions.${emojiName}`]: increment(1) });
        }

        // --- 10. ÎåìÍ∏Ä Í≤åÏãú ---
        async function handlePostComment(e, postId) {
            const form = e.target.closest('.new-comment-form');
            const input = form.querySelector('.comment-input');
            const text = input.value.trim();
            if (!text) return alert("Please enter a comment!");
            showLoading("Posting comment...");
            try {
                await addDoc(collection(db, postsCollectionPath, postId, 'comments'), { text, userId, createdAt: serverTimestamp() });
                input.value = '';
            } catch (error) {
                alert("Failed to post comment.");
            } finally {
                hideLoading();
            }
        }

        // --- 11. ÎãµÍ∏Ä Í≤åÏãú ---
        async function handlePostReply(e, postId, commentId) {
            const form = e.target.closest('.reply-form');
            const input = form.querySelector('.reply-input');
            const text = input.value.trim();
            if (!text) return alert("Please enter a reply!");
            showLoading("Posting reply...");
            try {
                await addDoc(collection(db, postsCollectionPath, postId, 'comments', commentId, 'replies'), { text, userId, createdAt: serverTimestamp() });
                form.style.display = 'none';
                input.value = '';
            } catch (error) {
                alert("Failed to post reply.");
            } finally {
                hideLoading();
            }
        }

        // --- 12. STT Ìï∏Îì§Îü¨ ---
        function handleSpeechRecognition(e, formElement) {
            e.preventDefault();
            if (!SpeechRecognition) return alert("Speech recognition is not supported.");
            const targetInput = formElement.querySelector('textarea, .comment-input, .reply-input, #new-description-input');
            if (!targetInput) return;
            if (isRecording) {
                if (currentRecordingTextarea === targetInput) recognition.stop();
                else alert("Another recording is in progress.");
            } else {
                currentRecordingTextarea = targetInput;
                try {
                    recognition.start();
                } catch (err) {
                    if (isRecording) recognition.stop();
                }
            }
        }

        // --- 12.5. Ïä§ÏôÄÏù¥ÌîÑ/ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏÇ≠Ï†úÌïòÎäî Í∏∞Îä• (ÌÑ∞Ïπò & ÎßàÏö∞Ïä§ Î™®Îëê ÏßÄÏõê) ---
        function addSwipeToDelete(element, deleteCallback) {
            let isDragging = false;
            let startX = 0;
            const swipeThreshold = 50;
            const cardContent = element.querySelector('.comment-card-content');

            function getEventX(e) {
                return e.touches ? e.touches[0].clientX : e.clientX;
            }

            function onDragStart(e) {
                if (e.button && e.button !== 0) return;
                isDragging = true;
                startX = getEventX(e);
                e.preventDefault();
                window.addEventListener('mousemove', onDragMove);
                window.addEventListener('touchmove', onDragMove, { passive: false });
                window.addEventListener('mouseup', onDragEnd);
                window.addEventListener('touchend', onDragEnd);
            }

            function onDragMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                const currentX = getEventX(e);
                let moveX = currentX - startX;
                if (moveX > 0) moveX = 0;
                if (moveX < -120) moveX = -120;
                cardContent.style.transition = 'none';
                cardContent.style.transform = `translateX(${moveX}px)`;
            }

            function onDragEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                const finalX = cardContent.getBoundingClientRect().left;
                const originalX = element.getBoundingClientRect().left;
                const diffX = originalX - finalX;
                cardContent.style.transition = 'transform 0.3s ease-in-out';
                if (diffX > swipeThreshold) {
                    cardContent.style.transform = 'translateX(-80px)';
                    element.classList.add('swiped');
                } else {
                    cardContent.style.transform = 'translateX(0)';
                    element.classList.remove('swiped');
                }
                window.removeEventListener('mousemove', onDragMove);
                window.removeEventListener('touchmove', onDragMove);
                window.removeEventListener('mouseup', onDragEnd);
                window.removeEventListener('touchend', onDragEnd);
            }

            element.addEventListener('mousedown', onDragStart);
            element.addEventListener('touchstart', onDragStart, { passive: false });

            const deleteBtn = element.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCallback();
                });
            }
        }

        // --- 12.6. ÎåìÍ∏Ä Î∞è ÎãµÍ∏Ä ÏÇ≠Ï†ú Ìï®Ïàò ---
        async function deleteComment(postId, commentId) {
            const commentRef = doc(db, postsCollectionPath, postId, 'comments', commentId);
            try {
                await deleteDoc(commentRef);
            } catch (error) {
                alert("Failed to delete comment.");
            }
        }

        async function deleteReply(postId, commentId, replyId) {
            const replyRef = doc(db, postsCollectionPath, postId, 'comments', commentId, 'replies', replyId);
            try {
                await deleteDoc(replyRef);
            } catch (error) {
                alert("Failed to delete reply.");
            }
        }

        // --- ÌååÏùº ÏûÖÎ†• Ïãú ÎØ∏Î¶¨Î≥¥Í∏∞ ---
        newFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    newImagePreview.src = event.target.result;
                    newImagePreviewContainer.classList.remove('hidden');
                    newFileLabel.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ïó∞Í≤∞ ---
        newPostForm.addEventListener('submit', submitNewPost);
        newRecordBtn.addEventListener('click', (e) => handleSpeechRecognition(e, newPostForm));

        // --- Ïï± ÏãúÏûë ---
        initializeAppAuth();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F0F9FF; color: #334155; }
        h1 { font-weight: 900; font-size: 2.5rem; line-height: 1.2; color: #1E40AF; text-shadow: 2px 2px 0 #BFDBFE; }
        h3 { font-weight: 700; font-size: 1.125rem; color: #1E3A8A; border-bottom: 2px solid #DBEAFE; padding-bottom: 4px; margin-bottom: 12px; }
        .card { background-color: white; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05); transition: all 0.2s ease-in-out; border: 2px solid white; }
        .card:hover { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); border-color: #93C5FD; }
        #add-post-card { border-style: dashed; border-width: 4px; border-color: #93C5FD; background-color: #EFF6FF; cursor: pointer; }
        #add-post-card:hover { background-color: #DBEAFE; border-color: #60A5FA; }
        #add-post-card p { font-size: 1.125rem; font-weight: 700; color: #2563EB; }
        #new-file-label { border-style: dashed; border-width: 4px; border-color: #93C5FD; background-color: #EFF6FF; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; min-height: 250px; border-radius: 1rem; }
        #new-file-label:hover { background-color: #DBEAFE; border-color: #60A5FA; }
        #new-image-preview-container { border: 2px solid #DBEAFE; border-radius: 1rem; min-height: 250px; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 700; font-size: 1rem; color: white; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn:active { transform: translateY(0); }
        .btn-pink { background-color: #F472B6; }
        .btn-pink:hover { background-color: #EC4899; }
        .btn-blue { background-color: #60A5FA; }
        .btn-blue:hover { background-color: #3B82F6; }
        textarea { border: 2px solid #DBEAFE; border-radius: 1rem; padding: 0.75rem 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        textarea:focus { border-color: #60A5FA; box-shadow: 0 0 0 3px #BFDBFE; outline: none; }
        .record-btn { font-size: 1.5rem; padding: 0.5rem; width: 3rem; height: 3rem; border-radius: 9999px; background-color: #FEE2E2; color: #EF4444; transition: all 0.2s; }
        .record-btn:hover { background-color: #FECACA; }
        .record-btn.is-recording { background-color: #EF4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 #F87171; } 70% { box-shadow: 0 0 0 10px rgba(248, 113, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); } }
        .reaction-btn { font-size: 1.5rem; padding: 0.5rem 1rem; border-radius: 9999px; background-color: #F3F4F6; transition: all 0.2s; }
        .reaction-btn:hover { background-color: #E5E7EB; transform: scale(1.1); }
        .reaction-btn .count { font-size: 1rem; font-weight: 700; color: #4B5563; margin-left: 0.5rem; }
        audio { width: 100%; height: 40px; margin-top: 8px; }
        #loading-overlay { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
        .replies-list { margin-left: 1.5rem; padding-left: 1rem; border-left: 2px solid #E5E7EB; }
        
        /* Ïä§ÏôÄÏù¥ÌîÑ Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .comment-card {
            background-color: #EF4444;
            border-radius: 1rem;
            margin-top: 8px;
            position: relative;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .comment-card-content {
            background-color: #F9FAFB;
            transition: transform 0.3s ease-in-out;
            position: relative;
            z-index: 10;
        }
        .delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 100%;
            background-color: #EF4444;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 1;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Ïï± Ï†ÑÏ≤¥ Ïª®ÌÖåÏù¥ÎÑà -->
    <div id="app-container" class="container mx-auto max-w-7xl p-4 md:p-8">
        
        <h1 class="text-center my-8">
            Footstep 2: Upload your MAP
        </h1>
        
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
            
            <div id="add-post-card" class="card flex flex-col p-5 space-y-3">
                <form id="new-post-form" class="flex flex-col space-y-4 h-full">
                    <div class="flex-grow">
                        <input type="file" id="new-file-input" class="hidden" accept="image/*">
                        <label id="new-file-label" for="new-file-input">
                            <span>+</span>
                            <p>Upload New Map</p>
                        </label>
                        <div id="new-image-preview-container" class="w-full aspect-w-4 aspect-h-3 bg-gray-100 rounded-lg overflow-hidden hidden">
                            <img id="new-image-preview" src="" alt="Image Preview" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div>
                        <label for="new-description-input" class="block text-sm font-medium text-gray-700 font-bold mb-2">
                            Add Description (Required)
                        </label>
                        <textarea id="new-description-input" class="w-full resize-none" rows="3" placeholder="What is this map about?" required></textarea>
                        <button type="button" id="new-record-btn" class="record-btn !w-10 !h-10 !text-lg mt-2" title="Record Description (STT)">üé§</button>
                    </div>
                    <button type="submit" id="new-post-submit-btn" class="btn btn-blue w-full">
                        Upload Post
                    </button>
                </form>
            </div>
            
        </div>
    </div>

    <!-- ÌÖúÌîåÎ¶ø ÏòÅÏó≠ -->
    <template id="post-template">
        <div class="post-card card flex flex-col overflow-hidden">
            <div class="w-full aspect-w-4 aspect-h-3 bg-gray-100">
                <img class="post-image w-full h-full object-cover" src="https://placehold.co/400x300/EEE/CCC?text=Loading..." alt="Post Image">
            </div>
            <div class="p-5 flex-grow flex flex-col">
                <div class="post-description-container mb-4 hidden">
                    <p class="post-description-text text-gray-700"></p>
                </div>
                <div class="reactions-container flex items-center gap-3 mb-4">
                    <button class="reaction-btn" data-emoji="heart">‚ù§Ô∏è <span class="count">0</span></button>
                    <button class="reaction-btn" data-emoji="smile">üòä <span class="count">0</span></button>
                </div>
                <div class="comments-section flex-grow flex flex-col">
                    <h3>Leave a Comment</h3>
                    <div class="new-comment-form space-y-3 mb-4">
                        <textarea class="comment-input w-full resize-none" rows="2" placeholder="Leave a wonderful comment!"></textarea>
                        <div class="flex items-center gap-3">
                            <button class="record-btn" title="Record Voice (STT)">üé§</button>
                            <button class="post-comment-btn btn btn-pink flex-grow">Post</button>
                        </div>
                    </div>
                    <div class="comments-list flex-grow space-y-2 overflow-y-auto max-h-[300px] pr-2"></div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="comment-template">
        <div class="comment-card">
            <div class="comment-card-content p-3 rounded-xl">
                <p class="comment-text text-gray-800"></p>
                <button class="reply-btn text-xs font-bold text-blue-500 hover:text-blue-700 mt-1">Reply</button>
                <div class="reply-form space-y-2 mt-2" style="display: none;">
                    <textarea class="reply-input w-full resize-none text-sm" rows="2" placeholder="Leave a reply..."></textarea>
                    <div class="flex items-center gap-2">
                        <button class="record-btn !text-base !w-9 !h-9" title="Record Voice (STT)">üé§</button>
                        <button class="post-reply-btn btn btn-blue !text-sm !py-2 !px-4 flex-grow">Post</button>
                    </div>
                </div>
                <div class="replies-list mt-2 space-y-2"></div>
            </div>
            <button class="delete-btn">Delete</button>
        </div>
    </template>

    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white rounded-2xl shadow-xl">
            <div class="w-12 h-12 border-4 border-t-blue-500 border-gray-200 rounded-full animate-spin mx-auto"></div>
            <p class="text-lg font-bold text-gray-700 mt-4">Uploading...</p>
        </div>
    </div>

</body>
</html>
