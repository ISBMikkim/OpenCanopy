<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Footstep 2: Upload your MAP</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK ìŠ¤í¬ë¦½íŠ¸ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            getDoc,
            updateDoc, 
            onSnapshot, 
            Timestamp,
            increment,
            serverTimestamp,
            query, // (NEW)
            orderBy // (NEW)
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytesResumable, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase ì„¤ì • ---
        
        // Canvas í™˜ê²½ì—ì„œ ì œê³µí•˜ëŠ” Firebase ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
              apiKey: "AIzaSyDRPKmza6cNgnxiT6qo4YHk4uiHue2j8ug",
              authDomain: "isbopencanopy-f92d3.firebaseapp.com",
              projectId: "isbopencanopy-f92d3",
              storageBucket: "isbopencanopy-f92d3.firebasestorage.app",
              messagingSenderId: "253275410619",
              appId: "1:253275410619:web:e20db952dc1f12f54f199e"
            };

        // Canvas í™˜ê²½ì—ì„œ ì œê³µí•˜ëŠ” App IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-map-app';

        // Firebase ì•±, ì¸ì¦, Firestore, Storage ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userId = null; // í˜„ì¬ ì‚¬ìš©ì ID
        
        // --- Speech Recognition (STT) ì„¤ì • ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let currentRecordingTextarea = null; // í˜„ì¬ STTê°€ ì…ë ¥ë  textarea
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // í•œ ë¬¸ì¥ì”©
            recognition.lang = 'en-US'; // ê¸°ë³¸ ì˜ì–´
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecording = true;
                // í˜„ì¬ ì…ë ¥ì°½ê³¼ ì—°ê²°ëœ ë…¹ìŒ ë²„íŠ¼ ì°¾ê¸°
                const recordBtn = currentRecordingTextarea.closest('form, .new-comment-form, .reply-form').querySelector('.record-btn');
                if (recordBtn) {
                    recordBtn.textContent = 'ğŸ›‘';
                    recordBtn.classList.add('is-recording');
                }
            };

            recognition.onend = () => {
                isRecording = false;
                if (currentRecordingTextarea) {
                    const recordBtn = currentRecordingTextarea.closest('form, .new-comment-form, .reply-form').querySelector('.record-btn');
                    if (recordBtn) {
                        recordBtn.textContent = 'ğŸ¤';
                        recordBtn.classList.remove('is-recording');
                    }
                }
                currentRecordingTextarea = null;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                if (currentRecordingTextarea) {
                    currentRecordingTextarea.value += transcript + ' '; // í…ìŠ¤íŠ¸ ì¶”ê°€
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                if (event.error === 'no-speech') {
                    alert("No speech was detected. Please try again.");
                } else if (event.error === 'audio-capture') {
                    alert("Microphone not found. Please check your settings.");
                } else if (event.error === 'not-allowed') {
                    alert("Permission to use microphone was denied. Please allow it in your browser settings.");
                }
                if (isRecording) {
                    recognition.stop();
                }
                // onendê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ë¯€ë¡œ UI ì •ë¦¬ëŠ” ê±°ê¸°ì„œ ì²˜ë¦¬ë¨
            };
        } else {
            console.warn("Speech Recognition not supported in this browser.");
        }


        // --- ê³µìš© ë°ì´í„° ê²½ë¡œ ---
        // ëª¨ë“  ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ê³µìœ í•´ì•¼ í•˜ë¯€ë¡œ public ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const postsCollectionPath = `artifacts/${appId}/public/data/student-maps`;

        // --- UI ìš”ì†Œ ---
        const postsGrid = document.getElementById('posts-grid');
        const addPostCard = document.getElementById('add-post-card');
        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- (REMOVED) ìƒˆ ì—…ë¡œë“œ Modal UI ìš”ì†Œ ---
        // const uploadModal = document.getElementById('upload-modal');
        // const cancelModalBtn = document.getElementById('cancel-modal-btn');
        // const postModalForm = document.getElementById('post-modal-form');
        // const modalFileInput = document.getElementById('modal-file-input');
        // const modalImagePreview = document.getElementById('modal-image-preview');
        // const modalDescriptionInput = document.getElementById('modal-description-input');
        // const modalRecordBtn = document.getElementById('modal-record-btn');

        // --- (NEW) ìƒˆ ì—…ë¡œë“œ í¼ UI ìš”ì†Œ (add-post-card ë‚´ë¶€) ---
        const newPostForm = document.getElementById('new-post-form');
        const newFileInput = document.getElementById('new-file-input');
        const newImagePreview = document.getElementById('new-image-preview');
        const newImagePreviewContainer = document.getElementById('new-image-preview-container');
        const newFileLabel = document.getElementById('new-file-label');
        const newDescriptionInput = document.getElementById('new-description-input');
        const newRecordBtn = document.getElementById('new-record-btn');
        
        // --- í…œí”Œë¦¿ ---
        const postTemplate = document.getElementById('post-template');
        const commentTemplate = document.getElementById('comment-template');

        // --- ë¡œë”© ì˜¤ë²„ë ˆì´ ---
        function showLoading(message = "Uploading...") {
            loadingOverlay.querySelector('p').textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // --- 1. ì¸ì¦ ë° ì•± ì´ˆê¸°í™” ---
        async function initializeAppAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Sign-in successful:", userId);
                    // userIdDisplay.textContent = `ë‚´ ID: ${userId} (ì¹œêµ¬ì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”!)`; // User ID í‘œì‹œ ì œê±°
                    loadPosts(); // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ë©´ ê²Œì‹œë¬¼ ë¡œë“œ
                } else {
                    // Canvas í† í°ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Sign-in failed:", error);
                        userIdDisplay.textContent = "Failed to sign in. Please refresh.";
                    }
                }
            });
        }

        // --- 2. ê²Œì‹œë¬¼ ë¡œë“œ (ì‹¤ì‹œê°„) ---
        function loadPosts() {
            // (MODIFIED) postsRefì— orderBy('createdAt') ì¿¼ë¦¬ ì¶”ê°€
            // Firestoreì—ì„œ ì§ì ‘ ì •ë ¬í•˜ë©°, docChanges()ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
            // (MODIFIED AGAIN) orderBy ì œê±°. ìˆ˜ë™ ìƒ‰ì¸(index) ìƒì„±ì´ í•„ìš”í•˜ì—¬ ë²„ê·¸ë¥¼ ìœ ë°œí•¨.
            // const postsRef = query(collection(db, postsCollectionPath), orderBy("createdAt", "asc"));
            const postsRef = query(collection(db, postsCollectionPath));
            
            // onSnapshotìœ¼ë¡œ ì‹¤ì‹œê°„ ë³€ê²½ ê°ì§€
            onSnapshot(postsRef, (snapshot) => {
                
                // (MODIFIED) "ëª¨ë‘ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¬ê¸°" ëŒ€ì‹  docChanges() ì‚¬ìš©
                snapshot.docChanges().forEach((change) => {
                    const postData = { id: change.doc.id, ...change.doc.data() };

                    if (change.type === "added") {
                        // ìƒˆ ê²Œì‹œë¬¼ì´ ì¶”ê°€ë¨ (renderPostê°€ addPostCard ì•ì— ì¶”ê°€)
                        renderPost(postData);
                    }
                    if (change.type === "modified") {
                        // ê¸°ì¡´ ê²Œì‹œë¬¼(ì´ëª¨ì§€)ì´ ìˆ˜ì •ë¨
                        // 1. ê¸°ì¡´ ì¹´ë“œ ì°¾ê¸°
                        const existingCard = document.querySelector(`.post-card[data-post-id="${postData.id}"]`);
                        if (existingCard) {
                            // 2. ì´ëª¨ì§€ ì¹´ìš´íŠ¸ë§Œ ì—…ë°ì´íŠ¸
                            const reactionsContainer = existingCard.querySelector('.reactions-container');
                            ['heart', 'smile'].forEach(emojiName => {
                                const countSpan = reactionsContainer.querySelector(`[data-emoji="${emojiName}"] .count`);
                                if(countSpan) {
                                    countSpan.textContent = postData.reactions[emojiName] || 0;
                                }
                            });
                            // (ì°¸ê³ ) ì„¤ëª… ë“±ì´ ìˆ˜ì •ë  ê²½ìš°, ì´ ë¶€ë¶„ì—ì„œ ë” ë§ì€ UIë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        }
                    }
                    if (change.type === "removed") {
                        // ê²Œì‹œë¬¼ì´ ì‚­ì œë¨
                        const existingCard = document.querySelector(`.post-card[data-post-id="${postData.id}"]`);
                        if (existingCard) {
                            existingCard.remove();
                        }
                    }
                });

                /* (REMOVED) ê¸°ì¡´ "ëª¨ë‘ ì§€ìš°ê¸°" ë¡œì§
                // ê¸°ì¡´ ê²Œì‹œë¬¼ ì¹´ë“œ ëª¨ë‘ ì‚­ì œ (ì¶”ê°€ ì¹´ë“œ ì œì™¸)
                document.querySelectorAll('.post-card').forEach(card => card.remove());
                
                // Firestoreì—ì„œ ë°›ì•„ì˜¨ ëª¨ë“  ë¬¸ì„œë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                const posts = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));

                // 'createdAt' í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë©”ëª¨ë¦¬ì—ì„œ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
                // serverTimestampëŠ” nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸
                posts.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeA - timeB;
                });

                // ì •ë ¬ëœ ê²Œì‹œë¬¼ì„ í™”ë©´ì— ë Œë”ë§
                posts.forEach(post => {
                    renderPost(post);
                });
                */
            });
        }

        // --- 3. ê²Œì‹œë¬¼ ì¹´ë“œ ë Œë”ë§ ---
        function renderPost(postData) {
            const postCard = postTemplate.content.cloneNode(true).firstElementChild;
            postCard.dataset.postId = postData.id;

            // ì´ë¯¸ì§€ ì„¤ì •
            const img = postCard.querySelector('.post-image');
            img.src = postData.imageUrl;
            img.alt = "Student's uploaded map";
            img.onerror = () => { 
                img.src = `https://placehold.co/400x300/F871B1/FFFFFF?text=IMAGE+FAILED`; 
                img.alt = "Could not load image.";
            };

            // --- (MODIFIED) ê²Œì‹œë¬¼ ì„¤ëª… í‘œì‹œ ---
            const descriptionContainer = postCard.querySelector('.post-description-container');
            const descriptionText = descriptionContainer.querySelector('.post-description-text');
            // const descriptionForm = descriptionContainer.querySelector('.description-form'); // REMOVED
            
            if (postData.description) {
                descriptionText.textContent = postData.description;
                descriptionContainer.classList.remove('hidden'); // ì»¨í…Œì´ë„ˆë¥¼ ë³´ì—¬ì¤Œ
            } else {
                descriptionContainer.classList.add('hidden'); // ì»¨í…Œì´ë„ˆë¥¼ ìˆ¨ê¹€
            }

            // (REMOVED) Description form event listeners
            // ... (descRecordBtn, descSaveBtn related logic removed) ...


            // ì´ëª¨ì§€ ë°˜ì‘ ë Œë”ë§ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const reactionsContainer = postCard.querySelector('.reactions-container');
            ['heart', 'smile'].forEach(emojiName => {
                const btn = reactionsContainer.querySelector(`[data-emoji="${emojiName}"]`);
                const countSpan = btn.querySelector('.count');
                countSpan.textContent = postData.reactions[emojiName] || 0;
                
                btn.onclick = () => handleReactionClick(postData.id, emojiName);
            });

            // ëŒ“ê¸€ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const postCommentBtn = postCard.querySelector('.post-comment-btn');
            const commentInput = postCard.querySelector('.comment-input');
            const recordBtn = postCard.querySelector('.record-btn');
            // const audioPreview = postCard.querySelector('.audio-preview'); // REMOVED

            postCommentBtn.onclick = (e) => handlePostComment(e, postData.id);
            recordBtn.onclick = (e) => handleSpeechRecognition(e, recordBtn.closest('.new-comment-form'));

            // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
            const commentsList = postCard.querySelector('.comments-list');
            loadComments(postData.id, commentsList);

            // 'ìƒˆ ì§€ë„ ì˜¬ë¦¬ê¸°' ì¹´ë“œ *ì•ì—* ìƒˆ ê²Œì‹œë¬¼ ì¶”ê°€
            // (MODIFIED) addPostCardëŠ” í•­ìƒ ì²« ë²ˆì§¸ì´ë¯€ë¡œ, ê·¸ ë‹¤ìŒì— ì¶”ê°€í•©ë‹ˆë‹¤.
            // postsGrid.insertBefore(postCard, addPostCard.nextSibling); // [í¼], [ê¸€3], [ê¸€2], [ê¸€1] ...
            
            // (NEW - MODIFIED) addPostCard *ì•ì—* ì¶”ê°€í•˜ì—¬ í¼ì´ í•­ìƒ ë§ˆì§€ë§‰ì— ì˜¤ë„ë¡ í•©ë‹ˆë‹¤.
            postsGrid.insertBefore(postCard, addPostCard); // [ê¸€1], [ê¸€2], [ê¸€3] ... [í¼]
        }

        // --- 4. ëŒ“ê¸€ ë¡œë“œ (ì‹¤ì‹œê°„) ---
        function loadComments(postId, commentsListContainer) {
            const commentsRef = collection(db, postsCollectionPath, postId, 'comments');
            
            onSnapshot(commentsRef, (snapshot) => {
                commentsListContainer.innerHTML = ''; // ê¸°ì¡´ ëŒ“ê¸€ ì‚­ì œ
                
                const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ëŒ“ê¸€ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
                comments.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeA - timeB;
                });
                
                comments.forEach(comment => {
                    renderComment(comment, commentsListContainer, postId);
                });
            });
        }

        // --- 5. ëŒ“ê¸€ ì¹´ë“œ ë Œë”ë§ ---
        function renderComment(commentData, commentsListContainer, postId) {
            const commentCard = commentTemplate.content.cloneNode(true).firstElementChild;
            
            const textEl = commentCard.querySelector('.comment-text');
            textEl.textContent = commentData.text || "Comment"; // "Voice Comment" -> "Comment"
            
            // ì‘ì„±ì í‘œì‹œ (ìµëª… ë˜ëŠ” ID)
            const authorEl = document.createElement('span');
            authorEl.className = 'text-xs text-gray-500 ml-2';
            authorEl.textContent = `(by anonymous)`; // ìµëª…ìœ¼ë¡œ í‘œì‹œ
            textEl.appendChild(authorEl);


            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (REMOVED)
            const audioEl = commentCard.querySelector('.comment-audio');
            if (audioEl) audioEl.remove();


            // 'ë‹µê¸€ ë‹¬ê¸°' ë²„íŠ¼ (ë‹µê¸€ì˜ ë‹µê¸€ì€ ë§‰ìŒ)
            const replyBtn = commentCard.querySelector('.reply-btn');
            const replyForm = commentCard.querySelector('.reply-form');
            
            if (replyBtn && replyForm) {
                replyBtn.onclick = () => {
                    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                };
                
                // ë‹µê¸€ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const postReplyBtn = replyForm.querySelector('.post-reply-btn');
                const recordBtn = replyForm.querySelector('.record-btn');
                
                postReplyBtn.onclick = (e) => handlePostReply(e, postId, commentData.id);
                recordBtn.onclick = (e) => handleSpeechRecognition(e, replyForm);
            }
            
            // ë‹µê¸€ ëª©ë¡ ë¡œë“œ
            const repliesList = commentCard.querySelector('.replies-list');
            loadReplies(postId, commentData.id, repliesList);
            
            commentsListContainer.appendChild(commentCard);
        }

        // --- 6. ë‹µê¸€ ë¡œë“œ (ì‹¤ì‹œê°„) ---
        function loadReplies(postId, commentId, repliesListContainer) {
            const repliesRef = collection(db, postsCollectionPath, postId, 'comments', commentId, 'replies');
            
            onSnapshot(repliesRef, (snapshot) => {
                repliesListContainer.innerHTML = ''; // ê¸°ì¡´ ë‹µê¸€ ì‚­ì œ
                
                const replies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ë‹µê¸€ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
                replies.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeA - timeB;
                });
                
                replies.forEach(reply => {
                    renderReply(reply, repliesListContainer);
                });
            });
        }

        // --- 7. ë‹µê¸€ ì¹´ë“œ ë Œë”ë§ ---
        function renderReply(replyData, repliesListContainer) {
            // ë‹µê¸€ì€ ëŒ“ê¸€ í…œí”Œë¦¿ì„ ì¬ì‚¬ìš©í•˜ë˜, 'Reply' ë²„íŠ¼ì€ ìˆ¨ê¹€
            const replyCard = commentTemplate.content.cloneNode(true).firstElementChild;
            
            const textEl = replyCard.querySelector('.comment-text');
            textEl.textContent = replyData.text || "Reply";
            
            // ì‘ì„±ì í‘œì‹œ
            const authorEl = document.createElement('span');
            authorEl.className = 'text-xs text-gray-500 ml-2';
            authorEl.textContent = `(by anonymous)`;
            textEl.appendChild(authorEl);

            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (REMOVED)
            const audioEl = replyCard.querySelector('.comment-audio');
            if (audioEl) audioEl.remove();
            
            // ë‹µê¸€ì˜ 'Reply' ë²„íŠ¼ ë° í¼ ìˆ¨ê¸°ê¸°
            const replyBtn = replyCard.querySelector('.reply-btn');
            if (replyBtn) replyBtn.remove();
            
            const replyForm = replyCard.querySelector('.reply-form');
            if (replyForm) replyForm.remove();

            // ë‹µê¸€ì˜ ë‹µê¸€ ëª©ë¡ ìˆ¨ê¸°ê¸°
            const repliesList = replyCard.querySelector('.replies-list');
            if (repliesList) repliesList.remove();

            repliesListContainer.appendChild(replyCard);
        }
        
        // --- 7.5. íŒŒì¼ ì—…ë¡œë“œ (ê³µìš© í•¨ìˆ˜) ---
        function uploadFile(file, storagePath) {
            return new Promise((resolve, reject) => {
                const storageRef = ref(storage, storagePath);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        // ì—…ë¡œë“œ ì§„í–‰ë¥  (í•„ìš”ì‹œ ì‚¬ìš©)
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.error("Upload failed:", error);
                        reject(error);
                    },
                    async () => {
                        // ì—…ë¡œë“œ ì™„ë£Œ í›„ ë‹¤ìš´ë¡œë“œ URL ë°›ê¸°
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            resolve(downloadURL);
                        } catch (error) {
                            reject(error);
                        }
                    }
                );
            });
        }

        // --- 8. ìƒˆ ê²Œì‹œë¬¼ ì¶”ê°€ --- (MODIFIED - Form ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
        async function handleAddNewPost(e) {
            e.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë°©ì§€
            
            const file = newFileInput.files[0];
            const description = newDescriptionInput.value.trim();

            if (!file) {
                alert("Please select an image to upload.");
                return;
            }
            if (!description) {
                alert("Please enter a description.");
                return;
            }

            showLoading("Uploading map...");
            
            try {
                // 1. íŒŒì¼ ì—…ë¡œë“œ
                const fileId = `${Date.now()}-${file.name}`;
                const imagePath = `artifacts/${appId}/public/images/${fileId}`;
                const imageUrl = await uploadFile(file, imagePath);

                // 2. Firestoreì— ìƒˆ ë¬¸ì„œ ì¶”ê°€ (ì„¤ëª… í¬í•¨)
                const postsRef = collection(db, postsCollectionPath);
                await addDoc(postsRef, {
                    imageUrl: imageUrl,
                    description: description, // (MODIFIED) ì„¤ëª… ë°”ë¡œ ì¶”ê°€
                    userId: userId,
                    createdAt: serverTimestamp(), // ì„œë²„ ì‹œê°„ ê¸°ì¤€
                    reactions: {
                        heart: 0,
                        smile: 0
                    }
                });

                console.log("New post added successfully!");
                
                // (NEW) í¼ ë¦¬ì…‹
                newPostForm.reset();
                newImagePreview.src = '';
                newImagePreviewContainer.classList.add('hidden');
                newFileLabel.classList.remove('hidden'); // '+' ë¼ë²¨ ë‹¤ì‹œ ë³´ì´ê¸°

            } catch (error) {
                console.error("Failed to add new post:", error);
                alert("Failed to upload post. Please try again.");
            } finally {
                hideLoading();
            }
        }

        // --- 9. ì´ëª¨ì§€ ë°˜ì‘ í´ë¦­ ---
        async function handleReactionClick(postId, emojiName) {
            const postRef = doc(db, postsCollectionPath, postId);
            
            try {
                // increment()ë¥¼ ì‚¬ìš©í•´ ë™ì‹œ í´ë¦­ì—ë„ ì•ˆì „í•˜ê²Œ ì¹´ìš´íŠ¸
                await updateDoc(postRef, {
                    [`reactions.${emojiName}`]: increment(1)
                });
            } catch (error) {
                console.error("Reaction update failed:", error);
            }
        }

        // --- 10. ëŒ“ê¸€ ê²Œì‹œ ---
        async function handlePostComment(e, postId) {
        const form = e.target.closest('.new-comment-form');
        const input = form.querySelector('.comment-input');
        // const audioPreview = form.querySelector('.audio-preview'); // REMOVED
        const text = input.value.trim();
        // const audioBlob = audioPreview.src ? await fetch(audioPreview.src).then(r => r.blob()) : null; // REMOVED

        if (!text) { // ì˜¤ë””ì˜¤ ì²´í¬ ì œê±°
            alert("Please enter a comment!");
            return;
        }

        showLoading("Posting comment...");

        try {
            // let audioUrl = null; // REMOVED
            // ... (audio upload logic removed) ...

            // Firestoreì— ëŒ“ê¸€ ì¶”ê°€
            const commentsRef = collection(db, postsCollectionPath, postId, 'comments');
            await addDoc(commentsRef, {
                text: text,
                // audioUrl: audioUrl, // REMOVED
                userId: userId,
                createdAt: serverTimestamp()
            });

            // í¼ ì´ˆê¸°í™”
            input.value = '';
            // audioPreview.src = ''; // REMOVED
            // audioPreview.classList.add('hidden'); // REMOVED
            // form.querySelector('.record-btn').textContent = 'ğŸ¤'; // STTê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬
        } catch (error) {
                console.error("Failed to post comment:", error);
                alert("Failed to post comment.");
            } finally {
                hideLoading();
            }
        }

        // --- 11. ë‹µê¸€ ê²Œì‹œ ---
        async function handlePostReply(e, postId, commentId) {
        const form = e.target.closest('.reply-form');
        const input = form.querySelector('.reply-input');
        // const audioPreview = form.querySelector('.audio-preview'); // REMOVED
        const text = input.value.trim();
        // const audioBlob = audioPreview.src ? await fetch(audioPreview.src).then(r => r.blob()) : null; // REMOVED

        if (!text) { // ì˜¤ë””ì˜¤ ì²´í¬ ì œê±°
            alert("Please enter a reply!");
            return;
        }

        showLoading("Posting reply...");
        
        try {
            // let audioUrl = null; // REMOVED
            // ... (audio upload logic removed) ...

            // Firestoreì— ë‹µê¸€ ì¶”ê°€
            const repliesRef = collection(db, postsCollectionPath, postId, 'comments', commentId, 'replies');
            await addDoc(repliesRef, {
                text: text,
                // audioUrl: audioUrl, // REMOVED
                userId: userId,
                createdAt: serverTimestamp()
            });

            // í¼ ì´ˆê¸°í™”
            input.value = '';
            // audioPreview.src = ''; // REMOVED
            // audioPreview.classList.add('hidden'); // REMOVED
            // form.querySelector('.record-btn').textContent = 'ğŸ¤'; // STTê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬
            form.style.display = 'none'; // í¼ ìˆ¨ê¸°ê¸°
        } catch (error) {
                console.error("Failed to post reply:", error);
                alert("Failed to post reply.");
            } finally {
                hideLoading();
            }
        }

        // --- (REMOVED) 11.5. ì„¤ëª… ì €ì¥ ---
        // async function handleSaveDescription(e, postId) { ... }

        // --- 12. ìŒì„± ë…¹ìŒ í† ê¸€ --- (REMOVED)
        // ... (toggleRecording function removed) ...

        // --- (NEW) 12. Speech-to-Text (STT) í•¸ë“¤ëŸ¬ ---
        function handleSpeechRecognition(e, formElement) {
            e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€ (í•„ìš”ì‹œ)
            if (!SpeechRecognition) {
                alert("Speech recognition is not supported in your browser.");
                return;
            }

            const targetInput = formElement.querySelector('textarea, .comment-input, .reply-input, #new-description-input'); // (MODIFIED)
            if (!targetInput) {
                console.error("STT Error: Could not find target textarea.");
                return;
            }

            if (isRecording) {
                if (currentRecordingTextarea === targetInput) {
                    // ê°™ì€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¤‘ì§€
                    recognition.stop();
                } else {
                    // ë‹¤ë¥¸ ë…¹ìŒì´ ì§„í–‰ ì¤‘
                    alert("Another recording is in progress. Please complete it first.");
                }
            } else {
                // ìƒˆ ë…¹ìŒ ì‹œì‘
                currentRecordingTextarea = targetInput;
                try {
                    recognition.start();
                } catch (err) {
                    console.error("STT start error:", err);
                    if (isRecording) {
                        recognition.stop();
                    }
                }
            }
        }

        // --- (REMOVED) 13. ì—…ë¡œë“œ Modal í•¨ìˆ˜ ---
        // function openUploadModal() { ... }
        // function closeUploadModal() { ... }

        // (NEW) ìƒˆ ê²Œì‹œë¬¼ í¼ íŒŒì¼ ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸°
        newFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    newImagePreview.src = event.target.result;
                    newImagePreviewContainer.classList.remove('hidden');
                    newFileLabel.classList.add('hidden'); // '+' ë¼ë²¨ ìˆ¨ê¸°ê¸°
                };
                reader.readAsDataURL(file);
            }
        });


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        
        // (NEW) ìƒˆ ê²Œì‹œë¬¼ í¼ ë¦¬ìŠ¤ë„ˆ
        newPostForm.addEventListener('submit', handleAddNewPost);
        newRecordBtn.addEventListener('click', (e) => handleSpeechRecognition(e, newPostForm));

        // (REMOVED) Modal ê´€ë ¨ ë¦¬ìŠ¤ë„ˆ
        // addPostCard.addEventListener('click', openUploadModal);
        // cancelModalBtn.addEventListener('click', closeUploadModal);
        // postModalForm.addEventListener('submit', submitNewPost);
        // modalRecordBtn.addEventListener('click', (e) => handleSpeechRecognition(e, postModalForm));

        // --- ì•± ì‹œì‘ ---
        initializeAppAuth();

    </script>
    
    <!-- ì•„ì´ë“¤ì„ ìœ„í•œ ê·€ì—¬ìš´ ìŠ¤íƒ€ì¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9FF; /* ì•„ì£¼ ì—°í•œ í•˜ëŠ˜ìƒ‰ */
            color: #334155; /* ì§™ì€ íšŒìƒ‰ */
        }

        h1 {
            font-weight: 900; /* ì•„ì£¼ êµµê²Œ */
            font-size: 2.5rem; /* 40px */
            line-height: 1.2;
            color: #1E40AF; /* ì§™ì€ íŒŒë‘ */
            text-shadow: 2px 2px 0 #BFDBFE; /* ì—°í•œ íŒŒë‘ ê·¸ë¦¼ì */
        }
        
        h3 {
            font-weight: 700;
            font-size: 1.125rem; /* 18px */
            color: #1E3A8A;
            border-bottom: 2px solid #DBEAFE;
            padding-bottom: 4px;
            margin-bottom: 12px;
        }

        /* ì¹´ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: white;
            border-radius: 1.5rem; /* 24px, ë” ë‘¥ê¸€ê²Œ */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            transition: all 0.2s ease-in-out;
            border: 2px solid white;
        }
        .card:hover {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-color: #93C5FD; /* hover ì‹œ ì—°í•œ íŒŒë‘ í…Œë‘ë¦¬ */
        }

        /* ìƒˆ ì§€ë„ ì¶”ê°€ ì¹´ë“œ */
        #add-post-card {
            border-style: dashed;
            border-width: 4px;
            border-color: #93C5FD; /* ì—°í•œ íŒŒë‘ */
            background-color: #EFF6FF; /* ì•„ì£¼ ì—°í•œ íŒŒë‘ */
            cursor: pointer;
        }
        #add-post-card:hover {
            background-color: #DBEAFE;
            border-color: #60A5FA;
        }
        #add-post-card p {
            font-size: 1.125rem; /* 18px */
            font-weight: 700;
            color: #2563EB;
        }

        /* (NEW) ìƒˆ ê²Œì‹œë¬¼ í¼ ìŠ¤íƒ€ì¼ */
        #new-file-label {
            border-style: dashed;
            border-width: 4px;
            border-color: #93C5FD;
            background-color: #EFF6FF;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1.5rem;
            min-height: 250px;
            border-radius: 1rem;
        }
        #new-file-label:hover {
            background-color: #DBEAFE;
            border-color: #60A5FA;
        }
        #new-image-preview-container {
            border: 2px solid #DBEAFE;
            border-radius: 1rem;
            min-height: 250px; /* ë¼ë²¨ê³¼ ìµœì†Œ ë†’ì´ í†µì¼ */
        }


        /* ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 0.75rem 1.5rem; /* 12px 24px */
            border-radius: 9999px; /* ì™„ì „ ë‘¥ê¸€ê²Œ */
            font-weight: 700;
            font-size: 1rem; /* 16px */
            color: white;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn:active {
            transform: translateY(0);
        }

        /* í•‘í¬ ë²„íŠ¼ */
        .btn-pink {
            background-color: #F472B6; /* í•‘í¬ */
        }
        .btn-pink:hover {
            background-color: #EC4899;
        }
        
        /* íŒŒë‘ ë²„íŠ¼ */
        .btn-blue {
            background-color: #60A5FA; /* íŒŒë‘ */
        }
        .btn-blue:hover {
            background-color: #3B82F6;
        }
        
        /* ëŒ“ê¸€ ì…ë ¥ì°½ */
        textarea {
            border: 2px solid #DBEAFE;
            border-radius: 1rem; /* 16px */
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus {
            border-color: #60A5FA;
            box-shadow: 0 0 0 3px #BFDBFE;
            outline: none;
        }
        
        /* ë…¹ìŒ ë²„íŠ¼ */
        .record-btn {
            font-size: 1.5rem; /* 24px */
            padding: 0.5rem; /* 8px */
            width: 3rem; /* 48px */
            height: 3rem; /* 48px */
            border-radius: 9999px;
            background-color: #FEE2E2; /* ì—°í•œ ë¹¨ê°• */
            color: #EF4444; /* ë¹¨ê°• */
            transition: all 0.2s;
        }
        .record-btn:hover {
            background-color: #FECACA;
        }
        /* ë…¹ìŒ ì¤‘ ì• ë‹ˆë©”ì´ì…˜ */
        .record-btn.is-recording {
            background-color: #EF4444;
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 #F87171; }
            70% { box-shadow: 0 0 0 10px rgba(248, 113, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); }
        }

        /* ì´ëª¨ì§€ ë°˜ì‘ ë²„íŠ¼ */
        .reaction-btn {
            font-size: 1.5rem; /* 24px */
            padding: 0.5rem 1rem; /* 8px 16px */
            border-radius: 9999px;
            background-color: #F3F4F6;
            transition: all 0.2s;
        }
        .reaction-btn:hover {
            background-color: #E5E7EB;
            transform: scale(1.1);
        }
        .reaction-btn .count {
            font-size: 1rem; /* 16px */
            font-weight: 700;
            color: #4B5563;
            margin-left: 0.5rem; /* 8px */
        }
        
        /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ */
        audio {
            width: 100%;
            height: 40px;
            margin-top: 8px;
        }
        
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
        
        /* ëŒ“ê¸€, ë‹µê¸€ ì¹´ë“œ */
        .comment-card {
            background-color: #F9FAFB; /* ì•„ì£¼ ì—°í•œ íšŒìƒ‰ */
            border-radius: 1rem; /* 16px */
            padding: 0.75rem 1rem; /* 12px 16px */
            margin-top: 8px;
        }
        .replies-list {
            margin-left: 1.5rem; /* 24px */
            padding-left: 1rem; /* 16px */
            border-left: 2px solid #E5E7EB; /* ì—°í•œ íšŒìƒ‰ */
        }
    </style>
</head>
<body class="antialiased">

    <!-- ì•± ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div id="app-container" class="container mx-auto max-w-7xl p-4 md:p-8">
        
        <!-- App Title -->
        <h1 class="text-center my-8">
            Footstep 2: Upload your MAP
        </h1>
        
        <!-- User ID Display (Hidden) -->
        <div id="user-id-display" class="text-center text-sm text-gray-600 mb-6 font-bold hidden">
            Connecting...
        </div>

        <!-- Posts Grid -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
            
            <!-- (MODIFIED) Add New Map Card -> ì´ì œ í¼ì…ë‹ˆë‹¤ -->
            <div id="add-post-card" class="card flex flex-col p-5 space-y-3">
                
                <form id="new-post-form" class="flex flex-col space-y-4 h-full">
                    
                    <!-- File Input & Preview -->
                    <div class="flex-grow">
                        <input type="file" id="new-file-input" class="hidden" accept="image/*">
                        
                        <!-- File Input Label (+) -->
                        <label id="new-file-label" for="new-file-input">
                            <span>+</span>
                            <p>Upload New Map</p>
                        </label>
                        
                        <!-- Image Preview -->
                        <div id="new-image-preview-container" class="w-full aspect-w-4 aspect-h-3 bg-gray-100 rounded-lg overflow-hidden hidden">
                            <img id="new-image-preview" src="" alt="Image Preview" class="w-full h-full object-cover">
                        </div>
                    </div>

                    <!-- Description Input (ë³„ë„ ìœˆë„ìš°) -->
                    <div>
                        <label for="new-description-input" class="block text-sm font-medium text-gray-700 font-bold mb-2">
                            Add Description (Required)
                        </label>
                        <textarea id="new-description-input" class="w-full resize-none" rows="3" placeholder="What is this map about?" required></textarea>

                        <button type="button" id="new-record-btn" class="record-btn !w-10 !h-10 !text-lg mt-2" title="Record Description (STT)">ğŸ¤</button>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="new-post-submit-btn" class="btn btn-blue w-full">
                        Upload Post
                    </button>

                </form>
            </div>

            <!-- Post cards will be added here by JS -->
            
        </div>
    </div>

    <!-- ê²Œì‹œë¬¼ ì¹´ë“œ í…œí”Œë¦¿ -->
    <template id="post-template">
        <div class="post-card card flex flex-col overflow-hidden">
            <!-- Image Area -->
            <div class="w-full aspect-w-4 aspect-h-3 bg-gray-100">
                <img class="post-image w-full h-full object-cover" src="https://placehold.co/400x300/EEE/CCC?text=Loading..." alt="Post Image">
            </div>
            
            <!-- Body Area (Reactions + Comments) -->
            <div class="p-5 flex-grow flex flex-col">
                
                <!-- (MODIFIED) Post Description Area -->
                <div class="post-description-container mb-4 hidden"> <!-- ê¸°ë³¸ ìˆ¨ê¹€ -->
                    <p class="post-description-text text-gray-700"></p>
                    
                    <!-- (REMOVED) Description Form -->
                    <!-- <form class="description-form space-y-3 hidden"> ... </form> -->
                </div>

                <!-- Emoji Reactions -->
                <div class="reactions-container flex items-center gap-3 mb-4">
                    <button class="reaction-btn" data-emoji="heart">
                        â¤ï¸ <span class="count">0</span>
                    </button>
                    <button class="reaction-btn" data-emoji="smile">
                        ğŸ˜Š <span class="count">0</span>
                    </button>
                </div>
                
                <!-- Comments Section -->
                <div class="comments-section flex-grow flex flex-col">
                    <h3>Leave a Comment</h3>
                    
                    <!-- New Comment Form -->
                    <div class="new-comment-form space-y-3 mb-4">
                        <textarea class="comment-input w-full resize-none" rows="2" placeholder="Leave a wonderful comment!"></textarea>
                        <div class="flex items-center gap-3">
                            <button class="record-btn" title="Record Voice (STT)">ğŸ¤</button>
                            <button class="post-comment-btn btn btn-pink flex-grow">Post</button>
                        </div>
                        <!-- <audio class="audio-preview hidden" controls></audio> --> <!-- (REMOVED) -->
                    </div>
                    
                    <!-- Comments List -->
                    <div class="comments-list flex-grow space-y-2 overflow-y-auto max-h-[300px] pr-2">
                        <!-- Comment cards will be added here by JS -->
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- ëŒ“ê¸€/ë‹µê¸€ ì¹´ë“œ í…œí”Œë¦¿ -->
    <template id="comment-template">
        <div class="comment-card">
            <p class="comment-text text-gray-800"></p>
            <!-- <audio class="comment-audio hidden" controls></audio> --> <!-- (REMOVED) -->
            <button class="reply-btn text-xs font-bold text-blue-500 hover:text-blue-700 mt-1">Reply</button>
            
            <!-- Reply Form (Hidden) -->
            <div class="reply-form space-y-2 mt-2" style="display: none;">
                <textarea class="reply-input w-full resize-none text-sm" rows="2" placeholder="Leave a reply..."></textarea>
                <div class="flex items-center gap-2">
                    <button class="record-btn !text-base !w-9 !h-9" title="Record Voice (STT)">ğŸ¤</button>
                    <button class="post-reply-btn btn btn-blue !text-sm !py-2 !px-4 flex-grow">Post</button>
                </div>
                <!-- <audio class="audio-preview hidden" controls></audio> --> <!-- (REMOVED) -->
            </div>
            
            <!-- Replies List -->
            <div class="replies-list mt-2 space-y-2">
                <!-- Reply cards will be added here by JS -->
            </div>
        </div>
    </template>

    <!-- (REMOVED) Upload New Map Modal -->
    <!-- <div id="upload-modal" ...> ... </div> -->

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white rounded-2xl shadow-xl">
            <div class="w-12 h-12 border-4 border-t-blue-500 border-gray-200 rounded-full animate-spin mx-auto"></div>
            <p class="text-lg font-bold text-gray-700 mt-4">Uploading...</p>
        </div>
    </div>

</body>
</html>



