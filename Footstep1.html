<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your First Mission</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        #custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #custom-modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        #custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #custom-modal.visible #custom-modal-content {
            transform: scale(1);
        }
        /* Animation for recording button */
        .is-recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(29, 78, 216, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0);
            }
        }
        
        /* --- Styles for Swipe-to-Delete --- */
        
        /* 1. The list item container */
        .note-item {
            position: relative;
            overflow: hidden; /* This hides the delete button */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }

        /* 2. The note content that moves */
        .note-content {
            position: relative;
            z-index: 10;
            background-color: #ffffff;
            padding: 1rem; /* p-4 */
            border-left: 4px solid #3b82f6;
            transition: transform 0.3s ease-out;
            /* Allow vertical scrolling but capture horizontal swipe */
            touch-action: pan-y; 
            cursor: grab;
            /* *** ADDED: Prevent text selection during drag *** */
            user-select: none;
            -webkit-user-select: none;
        }
        .note-item.is-dragging .note-content {
            transition: none; /* No transition while dragging */
            cursor: grabbing;
        }

        /* 3. The hidden delete action container */
        .note-delete-action {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 96px; /* w-24 */
            z-index: 0; /* Behind the content */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ef4444; /* bg-red-500 */
        }
        .delete-note-button {
            color: white;
            font-weight: 500;
            padding-left: 1rem;
            padding-right: 1rem;
            /* Make it fill the red area for easier clicks */
            width: 100%;
            height: 100%;
        }
        
        /* 4. The "swiped open" state */
        .note-item.is-swiped .note-content {
            transform: translateX(-96px); /* Move content left by width of delete button */
        }

    </style>
</head>
<!-- Added flex-col and padding for the new list -->
<body class="bg-blue-50 flex flex-col items-center justify-center min-h-screen p-4 py-20">

    <!-- Language Switcher (Moved outside the card) -->
    <div class="fixed top-6 right-6 z-50 bg-white p-2 rounded-lg shadow-md flex items-center space-x-2">
        <label for="language-switcher" class="text-sm font-medium text-gray-700">Language:</label>
        <select id="language-switcher" name="language" class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm">
            <option value="en" selected>English</option>
            <option value="ko">Korean</option>
            <option value="ja">Japanese</option>
            <option value="fr">French</option>
        </select>
    </div>

    <!-- Main card -->
    <div class="bg-white border-4 border-blue-200 rounded-2xl shadow-lg p-8 max-w-2xl w-full relative">
        
        <!-- Speaker button (Moved to top right of card) -->
        <button id="speaker-button" class="absolute top-8 right-8 bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2"
            aria-label="Read text aloud">
            <!-- Speaker SVG icon -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
            </svg>
        </button>

        <!-- Header -->
        <h1 id="main-title" class="flex items-center text-3xl font-bold text-gray-800">
            <span class="text-4xl mr-3">🚀</span>
            <!-- Wrapped the text in a span for easier and more reliable translation -->
            <span id="main-title-text">Your First Mission!</span>
        </h1>
        
        <!-- Mission title -->
        <h2 id="mission-title" class="mt-6 text-xl font-semibold text-blue-800">
            1. Introduce yourself to your walking partners!
        </h2>
        
        <!-- Mission description -->
        <p id="mission-desc" class="mt-2 text-gray-600">
            Write a little bit about yourself in the box below. What do you like to do for fun?
        </p>

        <!-- Text input area wrapper -->
        <div class="mt-6 relative">
            <textarea 
                id="mission-text"
                class="w-full h-60 border-2 border-blue-300 rounded-xl p-4 pr-16 resize-none focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder-gray-400"
                placeholder="My name is... and I love to play..."
            ></textarea>
            
            <!-- Mic button (positioned inside text area) -->
            <button id="mic-button" class="absolute bottom-4 right-4 bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2"
                aria-label="Start recording">
                <!-- Mic SVG icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            </button>
        </div>

        <!-- Save Button -->
        <div class="mt-6 flex justify-end">
            <button id="save-button" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition duration-200 disabled:opacity-50" disabled>
                <!-- Disabled initially until auth is ready -->
                <span id="save-button-text">Save</span>
            </button>
        </div>
        
    </div>

    <!-- Saved Records Section -->
    <div id="saved-records-container" class="max-w-2xl w-full mt-8">
        <h3 id="saved-records-title" class="text-2xl font-bold text-gray-700 mb-4">My Saved Notes</h3>
        <ul id="saved-records-list" class="space-y-3">
            <!-- Records will be dynamically inserted here -->
            <li id="loading-placeholder" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">Loading saved notes...</li>
        </ul>
    </div>

    <!-- Custom modal (replaces alert()) -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div id="custom-modal-content" class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">Notification</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">
                <!-- Message will be inserted here -->
            </p>
            <div class="mt-4 flex justify-end">
                <button id="modal-close-button" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** ADDED 'doc' and 'deleteDoc' ***
        import { getFirestore, collection, addDoc, query, onSnapshot, setLogLevel, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Translation Data ---
        const translations = {
            en: {
                mainTitle: "Your First Mission!",
                missionTitle: "1. Introduce yourself to your walking partners!",
                missionDesc: "Write a little bit about yourself in the box below. What do you like to do for fun?",
                placeholder: "My name is... and I love to play...",
                modalTitle: "Notification",
                modalClose: "OK",
                speechListening: "Listening... Speak now.",
                speechError: "Speech recognition error. Please try again.",
                speechNoMic: "Microphone access denied. Please allow microphone access in your browser settings.",
                speechNotSupported: "Speech recognition is not supported in your browser. Try using Chrome or Safari.",
                ttsNotSupported: "Text-to-Speech is not supported in your browser.",
                saveButton: "Save",
                saveSuccessTitle: "🎉 Great Job!",
                saveSuccessMessage: "Your mission notes have been saved!",
                saveWait: "Saving...",
                saveError: "Save Error",
                saveEmpty: "There is no text to save!",
                savedRecordsTitle: "My Saved Notes",
                loadingNotes: "Loading saved notes...",
                noNotes: "No notes saved yet. Type something and click Save!",
                deleteButton: "Delete",
                deleteError: "Error deleting note."
            },
            ko: {
                mainTitle: "첫 번째 미션!",
                missionTitle: "1. 걷기 파트너에게 자신을 소개하세요!",
                missionDesc: "아래 상자에 자신에 대해 간단히 적어보세요. 재미로 무엇을 하는 것을 좋아하시나요?",
                placeholder: "제 이름은... 이고, ...하는 것을 좋아합니다...",
                modalTitle: "알림",
                modalClose: "확인",
                speechListening: "듣고 있습니다... 지금 말씀하세요.",
                speechError: "음성 인식 오류. 다시 시도해 주세요.",
                speechNoMic: "마이크 접근이 거부되었습니다. 브라우저 설정에서 마이크 접근을 허용해 주세요.",
                speechNotSupported: "음성 인식이 브라우저에서 지원되지 않습니다. Chrome이나 Safari를 이용해 보세요.",
                ttsNotSupported: "텍스트 음성 변환(TTS)이 브라우저에서 지원되지 않습니다.",
                saveButton: "저장하기",
                saveSuccessTitle: "🎉 잘했어요!",
                saveSuccessMessage: "미션 노트가 저장되었습니다!",
                saveWait: "저장하는 중...",
                saveError: "저장 오류",
                saveEmpty: "저장할 내용이 없어요!",
                savedRecordsTitle: "내가 저장한 노트",
                loadingNotes: "저장된 노트를 불러오는 중...",
                noNotes: "아직 저장된 노트가 없어요. 무언가를 쓰고 '저장하기'를 눌러보세요!",
                deleteButton: "삭제",
                deleteError: "노트 삭제 중 오류 발생."
            },
            ja: {
                mainTitle: "最初のミッション！",
                missionTitle: "1. ウォーキングパートナーに自己紹介をしましょう！",
                missionDesc: "下のボックスにあなたのことを少し書いてください。 趣味は何ですか？",
                placeholder: "私の名前は...で、...するのが好きです...",
                modalTitle: "通知",
                modalClose: "OK",
                speechListening: "聞いています... どうぞお話しください。",
                speechError: "音声認識エラー。もう一度お試しください。",
                speechNoMic: "マイクへのアクセスが拒否されました。ブラウザの設定でマイクへのアクセスを許可してください。",
                speechNotSupported: "ご使用のブラウザは音声認識に対応していません。ChromeまたはSafariをお試しください。",
                ttsNotSupported: "テキスト読み上げは、ご使用のブラウザでサポートされていません。",
                saveButton: "保存",
                saveSuccessTitle: "🎉 よくできました！",
                saveSuccessMessage: "ミッションノートが保存されました！",
                saveWait: "保存しています...",
                saveError: "保存エラー",
                saveEmpty: "保存するテキストがありません！",
                savedRecordsTitle: "保存したノート",
                loadingNotes: "保存されたノートを読み込み中...",
                noNotes: "まだ保存されたノートはありません。何か入力して「保存」をクリックしてください。",
                deleteButton: "削除",
                deleteError: "ノートの削除エラー。"
            },
            fr: {
                mainTitle: "Votre Première Mission !",
                missionTitle: "1. Présentez-vous à vos partenaires de marche !",
                missionDesc: "Écrivez un peu sur vous dans la case ci-dessous. Qu'aimez-vous faire pour vous amuser ?",
                placeholder: "Je m'appelle... et j'aime jouer...",
                modalTitle: "Notification",
                modalClose: "OK",
                speechListening: "Je vous écoute... Parlez maintenant.",
                speechError: "Erreur de reconnaissance vocale. Veuillez réessayer.",
                speechNoMic: "Accès au microphone refusé. Veuillez autoriser l'accès au microphone dans les paramètres de votre navigateur.",
                speechNotSupported: "La reconnaissance vocale n'est not prise en charge par votre navigateur. Essayez d'utiliser Chrome ou Safari.",
                ttsNotSupported: "La synthèse vocale n'est not prise en charge par votre navigateur.",
                saveButton: "Enregistrer",
                saveSuccessTitle: "🎉 Bon Travail !",
                saveSuccessMessage: "Vos notes de mission ont été enregistrées !",
                saveWait: "Enregistrement...",
                saveError: "Erreur d'Enregistrement",
                saveEmpty: "Il n'y a pas de texte à enregistrer !",
                savedRecordsTitle: "Mes Notes Enregistrées",
                loadingNotes: "Chargement des notes...",
                noNotes: "Aucune note enregistrée pour le moment. Écrivez quelque chose et cliquez sur Enregistrer !",
                deleteButton: "Supprimer",
                deleteError: "Erreur de suppression."
            }
        };

        // Map simple language codes to more specific BCP 47 codes for Speech API
        const langMap = {
            en: 'en-US',
            ko: 'ko-KR',
            ja: 'ja-JP',
            fr: 'fr-FR'
        };

        // --- Select DOM elements ---
        const micButton = document.getElementById('mic-button');
        const speakerButton = document.getElementById('speaker-button');
        const missionText = document.getElementById('mission-text');
        const saveButton = document.getElementById('save-button');
        
        // Custom modal elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');
        
        // Language elements
        const languageSwitcher = document.getElementById('language-switcher');
        const mainTitleText = document.getElementById('main-title-text'); 
        const missionTitle = document.getElementById('mission-title');
        const missionDesc = document.getElementById('mission-desc');
        const saveButtonText = document.getElementById('save-button-text');
        const savedRecordsTitle = document.getElementById('saved-records-title');
        const loadingPlaceholder = document.getElementById('loading-placeholder');
        const savedRecordsList = document.getElementById('saved-records-list');

        // --- Speech Recognition (STT) Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Stop after first utterance
            recognition.interimResults = false; // Get final results only

            recognition.onstart = () => {
                isRecording = true;
                micButton.classList.add('is-recording');
                const lang = languageSwitcher.value;
                showModal(translations[lang].modalTitle, translations[lang].speechListening);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                missionText.value += transcript + ' '; // Append text
            };

            recognition.onerror = (event) => {
                const lang = languageSwitcher.value;
                const t = translations[lang];
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    showModal(t.modalTitle, t.speechNoMic);
                } else {
                    showModal(t.modalTitle, t.speechError);
                    console.error('Speech Recognition Error:', event.error);
                }
            };

            recognition.onend = () => {
                isRecording = false;
                micButton.classList.remove('is-recording');
                // Don't close modal immediately
            };
        }
        
        // --- *** FIX for double-save bug *** ---
        // Flag to ensure the app logic runs only once
        let isAppInitialized = false;

        // --- Main App Function (Definition) ---
        // This function contains all the logic that depends on Firebase (db, auth, userId)
        function runApp(auth, db, userId, appId) { // Added appId
            // *** Check if app is already initialized ***
            if (isAppInitialized) {
                console.warn("App is already initialized. Skipping runApp().");
                return;
            }
            isAppInitialized = true; // Set the flag
            
            console.log("App is running for user:", userId, "on app:", appId);

            // Enable the save button now that auth is ready
            saveButton.disabled = false;
            
            // Define the Firestore collection path
            const notesCollectionPath = `artifacts/${appId}/public/data/introduce`;

            // --- Functions ---

            // Function to update language
            function updateLanguage(lang) {
                const t = translations[lang];
                
                mainTitleText.textContent = t.mainTitle;
                missionTitle.textContent = t.missionTitle;
                missionDesc.textContent = t.missionDesc;
                missionText.placeholder = t.placeholder;
                modalCloseButton.textContent = t.modalClose;
                saveButtonText.textContent = t.saveButton;
                savedRecordsTitle.textContent = t.savedRecordsTitle;
                // Check if loadingPlaceholder still exists before updating
                const currentLoadingPlaceholder = document.getElementById('loading-placeholder');
                if(currentLoadingPlaceholder) currentLoadingPlaceholder.textContent = t.loadingNotes;

                // Update speech recognition language
                if (recognition) {
                    recognition.lang = langMap[lang] || 'en-US';
                }
                
                // Update existing delete buttons
                document.querySelectorAll('.delete-note-button').forEach(btn => {
                    btn.textContent = t.deleteButton;
                });
            }

            // Function to show custom modal (alert)
            function showModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                customModal.classList.add('visible');
            }

            // Close modal
            modalCloseButton.addEventListener('click', () => {
                customModal.classList.remove('visible');
            });

            // --- Event Listeners ---

            // Mic button click event
            micButton.addEventListener('click', () => {
                const lang = languageSwitcher.value;
                if (!SpeechRecognition) {
                    showModal(translations[lang].modalTitle, translations[lang].speechNotSupported);
                    micButton.disabled = true;
                    return;
                }
                if (isRecording) {
                    recognition.stop();
                } else {
                    try {
                        recognition.lang = langMap[languageSwitcher.value] || 'en-US';
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting recognition: ", e.message);
                        if(isRecording) recognition.stop();
                    }
                }
            });

            // Speaker button click event
            speakerButton.addEventListener('click', () => {
                const lang = languageSwitcher.value;
                if (!('speechSynthesis' in window)) {
                    showModal(translations[lang].modalTitle, translations[lang].ttsNotSupported);
                    speakerButton.disabled = true;
                    return;
                }
                const t = translations[lang];
                const promptText = `${t.mainTitle} ${t.missionTitle} ${t.missionDesc}`;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(promptText);
                utterance.lang = langMap[lang] || 'en-US';
                window.speechSynthesis.speak(utterance);
            });

            // Save button click event
            saveButton.addEventListener('click', async () => {
                const textToSave = missionText.value.trim();
                const lang = languageSwitcher.value;
                const t = translations[lang];

                if (!textToSave) {
                    showModal(t.modalTitle, t.saveEmpty);
                    return;
                }

                showModal(t.saveWait, "..."); // Show saving message
                saveButton.disabled = true;

                try {
                    await addDoc(collection(db, notesCollectionPath), {
                        text: textToSave,
                        authorId: userId, 
                        createdAt: serverTimestamp() 
                    });
                    
                    showModal(t.saveSuccessTitle, t.saveSuccessMessage);
                    missionText.value = ""; // Clear text area

                } catch (error) {
                    console.error("Error adding document: ", error);
                    showModal(t.saveError, error.message);
                } finally {
                    saveButton.disabled = false;
                }
            });

            // Language switcher event
            languageSwitcher.addEventListener('change', (e) => {
                updateLanguage(e.target.value);
                if (isRecording) recognition.stop();
                window.speechSynthesis.cancel();
            });

            // --- Firestore Real-time Listener ---
            onSnapshot(query(collection(db, notesCollectionPath)), (snapshot) => {
                const notes = [];
                snapshot.forEach((doc) => {
                    notes.push({ id: doc.id, ...doc.data() });
                });

                notes.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                savedRecordsList.innerHTML = ""; // Clear the list
                const lang = languageSwitcher.value;
                const t = translations[lang];

                if (notes.length === 0) {
                    const li = document.createElement('li');
                    li.className = "bg-white p-4 rounded-lg shadow text-center text-gray-500";
                    li.textContent = t.noNotes;
                    savedRecordsList.appendChild(li);
                } else {
                    notes.forEach(note => {
                        const li = document.createElement('li');
                        li.className = "note-item"; // Use new class for swipe styling
                        li.dataset.docId = note.id;

                        // Create delete action
                        const deleteAction = document.createElement('div');
                        deleteAction.className = "note-delete-action";
                        const deleteButton = document.createElement('button');
                        deleteButton.className = "delete-note-button";
                        deleteButton.dataset.id = note.id;
                        deleteButton.textContent = t.deleteButton; // Use translation
                        deleteAction.appendChild(deleteButton);
                        li.appendChild(deleteAction);

                        // Create content wrapper
                        const content = document.createElement('div');
                        content.className = "note-content";
                        
                        const text = document.createElement('p');
                        text.textContent = note.text;
                        text.className = "text-gray-800";
                        content.appendChild(text);

                        if (note.createdAt) {
                            const timestamp = document.createElement('span');
                            timestamp.textContent = note.createdAt.toDate().toLocaleString(langMap[lang]);
                            timestamp.className = "text-xs text-gray-500 mt-1 block";
                            content.appendChild(timestamp);
                        }
                        li.appendChild(content);

                        savedRecordsList.appendChild(li);
                    });
                }
            }, (error) => {
                console.error("onSnapshot error:", error);
                savedRecordsList.innerHTML = `<li class="bg-red-100 text-red-700 p-4 rounded-lg">Error loading notes.</li>`;
            });

            // --- SWIPE AND DELETE LOGIC (REVISED FOR MOUSE DRAG) ---
            
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let swipedItem = null; // The <li> element that is currently swiped

            // Function to close any open swipe menu
            const closeSwipedItem = () => {
                if (swipedItem) {
                    swipedItem.classList.remove('is-swiped');
                    const content = swipedItem.querySelector('.note-content');
                    if (content) content.style.transform = 'translateX(0px)';
                    swipedItem = null;
                }
            };

            // 1. Click Listener (for Delete Button)
            savedRecordsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-note-button')) {
                    const docId = e.target.dataset.id;
                    if (!docId) return;

                    const lang = languageSwitcher.value;
                    const t = translations[lang];

                    try {
                        const docRef = doc(db, notesCollectionPath, docId);
                        await deleteDoc(docRef);
                        // onSnapshot will automatically update the UI
                        // closeSwipedItem() will be called implicitly as the item is removed
                        swipedItem = null;
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        showModal(t.modalTitle, t.deleteError);
                    }
                }
            });

            // --- Handlers for document-level drag ---
            const onPointerMove = (e) => {
                if (!isDragging || !swipedItem) return;

                currentX = e.clientX;
                let diff = currentX - startX;

                // Only allow dragging left, max 96px
                if (diff > 0) diff = 0; 
                if (diff < -96) diff = -96; // 96px is w-24

                const content = swipedItem.querySelector('.note-content');
                if (content) content.style.transform = `translateX(${diff}px)`;
            };

            const onPointerEnd = (e) => {
                if (!isDragging || !swipedItem) {
                    isDragging = false;
                    return;
                }

                isDragging = false;
                swipedItem.classList.remove('is-dragging');
                const content = swipedItem.querySelector('.note-content');
                if (!content) return;
                
                const diff = currentX - startX;

                // If swiped more than 40px left, snap open
                if (diff < -40) {
                    swipedItem.classList.add('is-swiped');
                } else {
                    // Otherwise, snap closed
                    swipedItem.classList.remove('is-swiped');
                    swipedItem = null;
                }
                
                // Reset startX and currentX
                startX = 0;
                currentX = 0;

                // Remove document-level listeners
                document.removeEventListener('pointermove', onPointerMove);
                document.removeEventListener('pointerup', onPointerEnd);
                document.removeEventListener('pointercancel', onPointerEnd);
            };
            
            // 2. Pointer Down (Start Swipe/Drag)
            savedRecordsList.addEventListener('pointerdown', (e) => {
                const noteContent = e.target.closest('.note-content');
                if (!noteContent || e.button !== 0) return; // Not on content or not left click

                // Prevent default browser drag (text selection)
                e.preventDefault();

                isDragging = true;
                startX = e.clientX;
                currentX = e.clientX; // Initialize currentX
                const currentLi = noteContent.closest('.note-item');
                
                // If we click a new item, close the old one
                if (swipedItem && swipedItem !== currentLi) {
                    closeSwipedItem();
                }
                swipedItem = currentLi;
                
                swipedItem.classList.add('is-dragging');

                // Add document-level listeners
                document.addEventListener('pointermove', onPointerMove);
                document.addEventListener('pointerup', onPointerEnd);
                document.addEventListener('pointercancel', onPointerEnd);
            });
            
            // Close swiped item if clicking anywhere else
            document.addEventListener('click', (e) => {
                if (swipedItem && !savedRecordsList.contains(e.target)) {
                    closeSwipedItem();
                }
            }, true); // Use capture phase


            // Initial load
            updateLanguage(languageSwitcher.value);
        }

        // --- Firebase Configuration & Initialization ---
        
        // ** 1. FOR GITHUB/EXTERNAL DEPLOYMENT: PASTE YOUR CONFIG HERE **
        // UPDATED with your provided config
        const manualFirebaseConfig = {
            apiKey: "AIzaSyDRPKmza6cNgnxiT6qo4YHk4uiHue2j8ug",
            authDomain: "isbopencanopy-f92d3.firebaseapp.com",
            projectId: "isbopencanopy-f92d3",
            storageBucket: "isbopencanopy-f92d3.firebasestorage.app", // Used your value
            messagingSenderId: "253275410619",
            appId: "1:253275410619:web:e20db952dc1f12f54f199e"
        };
        // ***************************************************************

        // Check for Canvas environment variables
        const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const canvasAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Determine which config and appId to use
        // Use Canvas config if available, otherwise fall back to manual config
        const effectiveConfig = canvasConfig || manualFirebaseConfig;
        // Use Canvas appId if available, otherwise fall back to manual config's appId (or a default)
        const effectiveAppId = canvasAppId || effectiveConfig.appId || 'default-app-id';
        
        let app, auth, db;
        try {
            // Check if the chosen config is still the placeholder (it shouldn't be anymore)
            if (!effectiveConfig || (effectiveConfig.apiKey === "YOUR_API_KEY" && !canvasConfig)) {
                 // Throw error only if no canvasConfig AND manualConfig is still placeholder
                throw new Error("Firebase config is missing. If on GitHub, paste your config object into `manualFirebaseConfig` in the script.");
            }
            
            app = initializeApp(effectiveConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 

            // --- Firebase Authentication Listener ---
            onAuthStateChanged(auth, async (user) => {
                let currentUserId;
                if (user) {
                    console.log("User is signed in:", user.uid);
                    currentUserId = user.uid;
                } else {
                    console.log("User is not signed in. Attempting auth...");
                    try {
                        if (canvasAuthToken) {
                            await signInWithCustomToken(auth, canvasAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        currentUserId = auth.currentUser?.uid;
                    } catch (error) {
                        console.error("Authentication error:", error);
                        document.getElementById('loading-placeholder').textContent = "Authentication failed. Cannot load or save notes.";
                    }
                }

                if (currentUserId && db) {
                    // *** Pass all parameters to runApp ***
                    runApp(auth, db, currentUserId, effectiveAppId);
                } else {
                    console.error("Could not get User ID or DB. App cannot start.");
                    document.getElementById('loading-placeholder').textContent = "Error: Could not get User ID or DB.";
                }
            });

        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.body.innerHTML = "<h1>Error initializing the app. Please check console.</h1>";
            const errorElement = document.createElement('p');
            errorElement.textContent = "Details: " + e.message;
            errorElement.className = "text-red-500 text-center";
            document.body.appendChild(errorElement);
        }
    </script>

</body>
</html>

