<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your First Mission</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        #custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #custom-modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        #custom-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #custom-modal.visible #custom-modal-content {
            transform: scale(1);
        }
        /* Animation for recording button */
        .is-recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(29, 78, 216, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0);
            }
        }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">

    <!-- Language Switcher (Moved outside the card) -->
    <div class="fixed top-6 right-6 z-50 bg-white p-2 rounded-lg shadow-md flex items-center space-x-2">
        <label for="language-switcher" class="text-sm font-medium text-gray-700">Language:</label>
        <select id="language-switcher" name="language" class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm">
            <option value="en" selected>English</option>
            <option value="ko">Korean</option>
            <option value="ja">Japanese</option>
            <option value="fr">French</option>
        </select>
    </div>

    <!-- Main card -->
    <div class="bg-white border-4 border-blue-200 rounded-2xl shadow-lg p-8 max-w-2xl w-full relative">
        
        <!-- Header -->
        <h1 id="main-title" class="flex items-center text-3xl font-bold text-gray-800">
            <span class="text-4xl mr-3">ðŸš€</span>
            <!-- Wrapped the text in a span for easier and more reliable translation -->
            <span id="main-title-text">Your First Mission!</span>
        </h1>
        
        <!-- Mission title -->
        <h2 id="mission-title" class="mt-6 text-xl font-semibold text-blue-800">
            1. Introduce yourself to your walking partners!
        </h2>
        
        <!-- Mission description -->
        <p id="mission-desc" class="mt-2 text-gray-600">
            Write a little bit about yourself in the box below. What do you like to do for fun?
        </p>

        <!-- Text input area wrapper -->
        <div class="mt-6 relative">
            <textarea 
                id="mission-text"
                class="w-full h-60 border-2 border-blue-300 rounded-xl p-4 pr-16 resize-none focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder-gray-400"
                placeholder="My name is... and I love to play..."
            ></textarea>
            
            <!-- Mic button (positioned inside text area) -->
            <button id="mic-button" class="absolute bottom-4 right-4 bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2"
                aria-label="Start recording">
                <!-- Mic SVG icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            </button>
        </div>

        <!-- Speaker button wrapper (aligned to bottom-right of text area) -->
        <div class="flex justify-end mt-2">
            <button id="speaker-button" class="bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2"
                aria-label="Read text aloud">
                <!-- Speaker SVG icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.S53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Custom modal (replaces alert()) -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div id="custom-modal-content" class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">Notification</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">
                <!-- Message will be inserted here -->
            </p>
            <div class="mt-4 flex justify-end">
                <button id="modal-close-button" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Translation Data ---
        // Added new strings for speech functionality
        const translations = {
            en: {
                mainTitle: "Your First Mission!",
                missionTitle: "1. Introduce yourself to your walking partners!",
                missionDesc: "Write a little bit about yourself in the box below. What do you like to do for fun?",
                placeholder: "My name is... and I love to play...",
                modalTitle: "Notification",
                micMessage: "Starting voice recording... (simulation)",
                speakerMessageReading: "Reading text:",
                modalClose: "OK",
                speechListening: "Listening... Speak now.",
                speechError: "Speech recognition error. Please try again.",
                speechNoMic: "Microphone access denied. Please allow microphone access in your browser settings.",
                speechNotSupported: "Speech recognition is not supported in your browser. Try using Chrome or Safari.",
                ttsNotSupported: "Text-to-Speech is not supported in your browser."
            },
            ko: {
                mainTitle: "ì²« ë²ˆì§¸ ë¯¸ì…˜!",
                missionTitle: "1. ê±·ê¸° íŒŒíŠ¸ë„ˆì—ê²Œ ìžì‹ ì„ ì†Œê°œí•˜ì„¸ìš”!",
                missionDesc: "ì•„ëž˜ ìƒìžì— ìžì‹ ì— ëŒ€í•´ ê°„ë‹¨ížˆ ì ì–´ë³´ì„¸ìš”. ìž¬ë¯¸ë¡œ ë¬´ì—‡ì„ í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?",
                placeholder: "ì œ ì´ë¦„ì€... ì´ê³ , ...í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•©ë‹ˆë‹¤...",
                modalTitle: "ì•Œë¦¼",
                micMessage: "ìŒì„± ë…¹ìŒì„ ì‹œìž‘í•©ë‹ˆë‹¤... (ì‹œë®¬ë ˆì´ì…˜)",
                speakerMessageReading: "í…ìŠ¤íŠ¸ ì½ëŠ” ì¤‘:",
                modalClose: "í™•ì¸",
                speechListening: "ë“£ê³  ìžˆìŠµë‹ˆë‹¤... ì§€ê¸ˆ ë§ì”€í•˜ì„¸ìš”.",
                speechError: "ìŒì„± ì¸ì‹ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
                speechNoMic: "ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.",
                speechNotSupported: "ìŒì„± ì¸ì‹ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì´ë‚˜ Safarië¥¼ ì´ìš©í•´ ë³´ì„¸ìš”.",
                ttsNotSupported: "í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜(TTS)ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            },
            ja: {
                mainTitle: "æœ€åˆã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼",
                missionTitle: "1. ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«è‡ªå·±ç´¹ä»‹ã‚’ã—ã¾ã—ã‚‡ã†ï¼",
                missionDesc: "ä¸‹ã®ãƒœãƒƒã‚¯ã‚¹ã«ã‚ãªãŸã®ã“ã¨ã‚’å°‘ã—æ›¸ã„ã¦ãã ã•ã„ã€‚ è¶£å‘³ã¯ä½•ã§ã™ã‹ï¼Ÿ",
                placeholder: "ç§ã®åå‰ã¯...ã§ã€...ã™ã‚‹ã®ãŒå¥½ãã§ã™...",
                modalTitle: "é€šçŸ¥",
                micMessage: "éŸ³å£°éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™... (ã‚·ë®¬ë ˆì´ì…˜)",
                speakerMessageReading: "ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿ä¸Šã’ã¦ã„ã¾ã™:",
                modalClose: "OK",
                speechListening: "èžã„ã¦ã„ã¾ã™... ã©ã†ãžãŠè©±ã—ãã ã•ã„ã€‚",
                speechError: "éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
                speechNoMic: "ãƒžã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒžã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚",
                speechNotSupported: "ã”ä½¿ç”¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã¾ãŸã¯Safariã‚’ãŠè©¦ã—ãã ã•ã„ã€‚",
                ttsNotSupported: "ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’ã¯ã€ã”ä½¿ç”¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            },
            fr: {
                mainTitle: "Votre PremiÃ¨re Mission !",
                missionTitle: "1. PrÃ©sentez-vous Ã  vos partenaires de marche !",
                missionDesc: "Ã‰crivez un peu sur vous dans la case ci-dessous. Qu'aimez-vous faire pour vous amuser ?",
                placeholder: "Je m'appelle... et j'aime jouer...",
                modalTitle: "Notification",
                micMessage: "DÃ©marrage de l'enregistrement vocal... (simulation)",
                speakerMessageReading: "Lecture du texte :",
                modalClose: "OK",
                speechListening: "Je vous Ã©coute... Parlez maintenant.",
                speechError: "Erreur de reconnaissance vocale. Veuillez rÃ©essayer.",
                speechNoMic: "AccÃ¨s au microphone refusÃ©. Veuillez autoriser l'accÃ¨s au microphone dans les paramÃ¨tres de votre navigateur.",
                speechNotSupported: "La reconnaissance vocale n'est pas prise en charge par votre navigateur. Essayez d'utiliser Chrome ou Safari.",
                ttsNotSupported: "La synthÃ¨se vocale n'est pas prise en charge par votre navigateur."
            }
        };

        // Map simple language codes to more specific BCP 47 codes for Speech API
        const langMap = {
            en: 'en-US',
            ko: 'ko-KR',
            ja: 'ja-JP',
            fr: 'fr-FR'
        };

        // --- Select DOM elements ---
        const micButton = document.getElementById('mic-button');
        const speakerButton = document.getElementById('speaker-button');
        const missionText = document.getElementById('mission-text');
        
        // Custom modal elements
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');
        
        // Language elements
        const languageSwitcher = document.getElementById('language-switcher');
        const mainTitleText = document.getElementById('main-title-text'); 
        const missionTitle = document.getElementById('mission-title');
        const missionDesc = document.getElementById('mission-desc');
        const modalTitle = document.getElementById('modal-title');

        // --- Speech Recognition (STT) Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Stop after first utterance
            recognition.interimResults = false; // Get final results only

            recognition.onstart = () => {
                isRecording = true;
                micButton.classList.add('is-recording');
                const lang = languageSwitcher.value;
                showModal(translations[lang].speechListening);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                missionText.value += transcript + ' '; // Append text
            };

            recognition.onerror = (event) => {
                const lang = languageSwitcher.value;
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    showModal(translations[lang].speechNoMic);
                } else {
                    showModal(translations[lang].speechError);
                    console.error('Speech Recognition Error:', event.error);
                }
            };

            recognition.onend = () => {
                isRecording = false;
                micButton.classList.remove('is-recording');
                // Don't close modal immediately, user might be reading it
                // modalCloseButton.click(); 
            };
        }

        // --- Functions ---

        // Function to update language
        function updateLanguage(lang) {
            const t = translations[lang];
            
            mainTitleText.textContent = t.mainTitle;
            missionTitle.textContent = t.missionTitle;
            missionDesc.textContent = t.missionDesc;
            missionText.placeholder = t.placeholder;
            modalTitle.textContent = t.modalTitle;
            modalCloseButton.textContent = t.modalClose;

            // Update speech recognition language
            if (recognition) {
                recognition.lang = langMap[lang] || 'en-US';
            }
        }

        // Function to show custom modal (alert)
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.classList.add('visible');
        }

        // Close modal
        modalCloseButton.addEventListener('click', () => {
            customModal.classList.remove('visible');
        });

        // --- Event Listeners ---

        // Mic button click event
        micButton.addEventListener('click', () => {
            if (!SpeechRecognition) {
                const lang = languageSwitcher.value;
                showModal(translations[lang].speechNotSupported);
                micButton.disabled = true;
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.lang = langMap[languageSwitcher.value] || 'en-US';
                    recognition.start();
                } catch (e) {
                    // Handle errors if recognition is already started
                    console.error("Error starting recognition: ", e.message);
                    if(isRecording) recognition.stop(); // Try to stop it
                }
            }
        });

        // Speaker button click event
        speakerButton.addEventListener('click', () => {
            if (!('speechSynthesis' in window)) {
                const lang = languageSwitcher.value;
                showModal(translations[lang].ttsNotSupported);
                speakerButton.disabled = true;
                return;
            }

            const lang = languageSwitcher.value;
            const t = translations[lang];
            
            // Always read the mission prompt
            const promptText = `${t.mainTitle} ${t.missionTitle} ${t.missionDesc}`;
            
            // Stop any previous speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(promptText);
            utterance.lang = langMap[lang] || 'en-US';
            
            window.speechSynthesis.speak(utterance);
        });

        // Language switcher event
        languageSwitcher.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
            // Stop any ongoing speech or recognition when language changes
            if (isRecording) recognition.stop();
            window.speechSynthesis.cancel();
        });

        // Initial load
        updateLanguage(languageSwitcher.value);
    </script>

</body>
</html>

